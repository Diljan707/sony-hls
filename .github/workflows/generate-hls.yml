name: Generate PTC Punjabi HLS

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Install ffmpeg
      run: sudo apt-get update && sudo apt-get install -y ffmpeg

    - name: Generate HLS From TS Stream
      run: |
        mkdir -p hls
        ffmpeg \
        -reconnect 1 -reconnect_at_eof 1 -reconnect_streamed 1 -reconnect_delay_max 2 \
        -i "http://103.182.170.32:8888/play/a04g" \
        -c copy \
        -hls_time 4 \
        -hls_list_size 5 \
        -hls_flags delete_segments+independent_segments \
        hls/index.m3u8

    - name: Commit and push HLS
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git add hls/*
        git commit -m "Update HLS" || echo "No changes"
        git push
